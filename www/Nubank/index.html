<!DOCTYPE html>
<html lang="pt-Br" style=" height: 100%; width: 100%;">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply</title>

    <script src="/Library/js/core/coreIncrement.js?" type='text/javascript'></script>
    <script src="/Library/js/core/core.js?" type='text/javascript'></script>

    <script type='text/javascript'>
        var config = {};

        var CarregaDados = async () => {
            return new Promise((resolve) => {

                var options = AjaxOptions;
                options.url = `${urlAPI}/api/Syncronize/Get`;

                options.onload = (xhr, obj) => {

                    if (xhr.currentTarget.response != null && xhr.currentTarget.response != undefined) {
                        if (xhr.currentTarget.response.success == false) {
                            alert(`Ocorreu um erro: ${xhr.currentTarget.response.erroMsg}`);
                            resolve(null);
                        }

                        var Wallet = xhr.currentTarget.response.objeto;

                        resolve(Wallet);
                    } else {
                        alert("Nenhuma carteira foi encontrada");
                    }
                }

                Ajax(options);
            });
        }

        var ImplementList = {
            Cards: (index, codCard, amount, timeString, title, description, codBank, codWallet) => {
                try {
                    var card = Scripts.Elements.Create('li', null, null,
                        null, null, ['list-group-item', 'd-flex', 'justify-content-between', 'align-items-start', 'cards']);

                    card.dataset['cod'] = codCard;

                    var cabecalho = Scripts.Elements.Create('div', null, null,
                        null, 'width: 100%;', ['ms-2', 'me-auto']);

                    cabecalho.innerText = `${description} - ${amount}`;

                    var titulo = Scripts.Elements.Create('div', null, null,
                        'fw-bold', null);

                    //titulo.innerText = title;

                    //var spanIndex = Scripts.Elements.Create('span', 'listCard', null,
                    //    null, null, ['badge', 'bg-primary', 'rounded-pill']);

                    //spanIndex.innerText = index;

                    var spanTime = Scripts.Elements.Create('span', 'listCard', null,
                        null, null, ['badge', 'bg-primary', 'rounded-pill', 'spanTime']);

                    spanTime.innerText = timeString;


                    cabecalho.appendChild(titulo);
                    //cabecalho.appendChild(spanIndex);

                    card.appendChild(cabecalho);

                    card.appendChild(spanTime);

                    return card;

                } catch (error) {
                    console.log(error);
                }
            }
        }

        var ImplementGrafico = async () => {
            try {
                var Wallet = await CarregaDados();

                var chartData = ChartData;

                var data = new Array;
                var dataSet = new Array;
                var label = new Array;
                var totalizador = 0;

                var ol = Scripts.Elements.Create('ol', 'listCard', null, null, 'padding-top: 9% !important; height: 100% !important; overflow: auto !important;', ['list-group', 'list-group-numbered']);

                var configTime = new Array();

                for (var i = 0; i < Wallet.cards.length; i++) {
                    ol.appendChild(ImplementList.Cards(i + 1, Wallet.cards[i].codCard, Wallet.cards[i].amount,
                        Wallet.cards[i].timeString, Wallet.cards[i].title, Wallet.cards[i].description));

                    totalizador += parseFloat(Wallet.cards[i].amount.replaceAll("R$", "").replaceAll(",", "."));
                }

                for (i = 0; i < Wallet.timeString.length; i++) {
                    configTime.push([Wallet.timeString[i], `rgb(${Math.round(Math.random() * 255)}, ${Math.round(Math.random() * 255)}, ${Math.round(Math.random() * 255)})`]);

                    var result = Wallet.cards.find(x => x.timeString == Wallet.timeString[i]);

                    if (Array.isArray(result)) {
                        var total = 0;
                        for (o = 0; o < result.length; o++) {
                            total += parseFloat(Wallet.cards[i].amount.replaceAll("R$", "").replaceAll(",", "."));
                        }

                        data.push(total);

                    } else if (result != null) {
                        data.push(parseFloat(result.amount.replaceAll("R$", "").replaceAll(",", ".")));
                    }

                    dataSet.push({
                        label: Wallet.timeString[i],
                        data: data,
                        backgroundColor: configTime.find(x => x[0] == Wallet.cards[i].timeString)[1],
                        borderWidth: 2,
                        borderColor: configTime.find(x => x[0] == Wallet.cards[i].timeString)[1]
                    });

                    label.push(Wallet.timeString[i]);
                }

                document.getElementById("listCards").appendChild(ol);

                var divTotalizador = Scripts.Elements.Create('div', null, null,
                    null, "display: flex; align-items: center; justify-content: center;", ['totalizador', 'cards']);

                var spanTotalizador = Scripts.Elements.Create('span', null, null,
                    null);

                spanTotalizador.innerText = `Total: ${totalizador.toLocaleBR(totalizador)}`;
                divTotalizador.appendChild(spanTotalizador);
                document.getElementById("listCards").appendChild(divTotalizador);


                chartData.labels = label;
                chartData.datasets = dataSet;

                Scripts.Grafico.NewChart(Scripts.Grafico.ConfigChart('line', chartData),
                    "graficoLine");

                Scripts.Grafico.NewChart(Scripts.Grafico.ConfigChart('doughnut', chartData),
                    "graficoDoughnut");

                Scripts.Grafico.NewChart(Scripts.Grafico.ConfigChart('bubble', chartData),
                    "graficoBubble");

                Scripts.Grafico.NewChart(Scripts.Grafico.ConfigChart('bar', chartData),
                    "graficoBar");

            } catch (error) {
                console.log(error);
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            ImplementGrafico();
        });
    </script>

    <link rel="stylesheet" href="/Library/css/style.padrao.css">

    <style>
        .panel {
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-content: center;
            text-align: center;
            padding-top: 12% !important;
        }

        .spanTime {
            background-color: white !important;
            color: var(--colorPrymary5) !important;                        
        }

        .cards {
            background-color: var(--colorPrymary5) !important;
            color: white !important;
            border: 0.5px solid white;
            border-radius: 10px;
        }

            .cards:hover .spanTime {
                background-color: var(--colorPrymary5) !important;
                color: white !important;
                font-weight: 600 !important;
                transition: background-color 0.5s;
            }

            .cards:hover{
                background-color: white !important;
                color: var(--colorPrymary5) !important;
                font-weight: 600 !important;
                transition: background-color 0.5s;
            }
        
        .totalizador {
            width: 100%;
            height: 60px;
            background-color: var(--colorPrymary5);
            border-radius: 10px;
            margin-top: 21px;
        }
    </style>
</head>
<body>
    <img class="logo" src="img/nubank-logo.png" alt="Logo-Nubank" />
    <div class="panel">
        <div class="container">
            <h1 style="color: var(--colorPrymary5);">Estatisticas</h1>

            <div id="carouselExampleInterval" class="carousel slide">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <canvas id="graficoLine"></canvas>
                    </div>
                    <div class="carousel-item">
                        <canvas id="graficoDoughnut"></canvas>
                    </div>
                    <div class="carousel-item">
                        <canvas id="graficoBubble"></canvas>
                    </div>
                    <div class="carousel-item">
                        <canvas id="graficoBar"></canvas>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleInterval" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleInterval" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <div id="listCards" style="height: 59% !important;" class="container"></div>
    </div>
</body>
</html>