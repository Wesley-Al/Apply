<!DOCTYPE html>
<html lang="pt-Br" style=" height: 100%; width: 100%;">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intru</title>
    <link rel="sortcut icon" href="/favicon.ico" type="image/x-icon" />

    <script src="/Library.Front/Library/js/core/coreIncrement.js?" type='text/javascript'></script>
    <script src="/Library.Front/Library/js/core/core.js?" type='text/javascript'></script>

    <script type='text/javascript'>
        var config = {};

        var AtualizaDados = (event, element) => {
            try{                                       
               // var icon = Scripts.Elements.Create('i', 'icoRefresh', null, null, null, ['far', 'fa-dot-circle']);

                var options = document.querySelectorAll('input[name=month]:checked');

                if(options.length > 0){
                    document.getElementById('icoRefresh').classList;            
                }
               
            }catch(Error){

            }
        }

        var AtualizaList = () => {
            try{
                
                var inputs = document.querySelectorAll('input[name=month]:checked');
                var options = new Array();

                for(var i = 0; i < inputs.length; i++){
                    options.push(inputs[i].value);
                }

                document.getElementById('monthOptions').innerText = options.join(' - ') == "" ? 'All' : options.join(' - ');

                var divCarrousel = document.querySelectorAll('div[name=frameCarrousel]');

                document.getElementsByClassName('totalizador')[0]?.remove();
                document.getElementById('listCard')?.remove();                
                document.getElementById('graficoLine')?.remove()
                document.getElementById('graficoBar')?.remove();

                divCarrousel[0].appendChild(Scripts.Elements.Create('canvas', 'graficoLine'));
                divCarrousel[1].appendChild(Scripts.Elements.Create('canvas', 'graficoBar'));

                ImplementGrafico(options);
               
            }catch(Error){
                alert(Error);
            }
        }

        var CarregaDados = async (dataOptions) => {
            return new Promise((resolve) => {
                var options = AjaxOptions;
                var dataJoined = dataOptions != null && dataOptions != undefined ? dataOptions.join(',') : '';

                options.url = `${urlAPI}Syncronize/GetById?usuCod=${recuperaUserCodCookie()}&dataJoined=${dataJoined}`;
                options.method = 'POST';
                options.async = false;

                options.onload = (xhr, obj) => {
                    
                    if (xhr.currentTarget.response != null && xhr.currentTarget.response != undefined) {
                        if (xhr.currentTarget.response.success == false) {
                            Scripts.Elements.Message.Error(`Ocorreu um erro: ${xhr.currentTarget.response.erroMsg}`);
                            resolve(null);
                        }                        

                        var Wallet;

                        if (xhr.currentTarget.response.Objeto != undefined && xhr.currentTarget.response.Objeto != null) {
                            Wallet = xhr.currentTarget.response.Objeto;
                        } else {
                            Wallet = {
                                Cards: [],
                                Payments: [],
                                FlowClosed: []
                            }
                        }

                        resolve(Wallet);
                    } else {
                        alert("Nenhuma carteira foi encontrada");
                    }
                }
                
                 
                if(dataOptions != null && dataOptions != undefined ){
                    if(dataOptions.length > 0){
                        dataJoined = dataOptions.join(',');
                    }
                }

              /*  options.data = { 
                    usuCod: recuperaUserCodCookie(),
                    dataJoined: dataJoined
                };*/
                
                Scripts.API.POST(options);
            });
        }

        var ImplementList = {
            Cards: (index, codCard, amount, timeString, title, description, codBank, codWallet) => {
                try {
                    var card = Scripts.Elements.Create('li', null, null,
                        null, null, ['list-group-item', 'd-flex', 'justify-content-between', 'align-items-start', 'cards']);

                    card.dataset['cod'] = codCard;

                    var cabecalho = Scripts.Elements.Create('div', null, null,
                        null, 'width: 100%;', ['ms-2', 'me-auto']);

                    cabecalho.appendChild(Scripts.Elements.Create('i', null, null,
                        null, null, ['fas', 'fa-check-circle']));

                    cabecalho.innerText = `${description} - ${amount}`;

                    var titulo = Scripts.Elements.Create('div', null, null,
                        'fw-bold', null);

                    //titulo.innerText = title;

                    //var spanIndex = Scripts.Elements.Create('span', 'listCard', null,
                    //    null, null, ['badge', 'bg-primary', 'rounded-pill']);

                    //spanIndex.innerText = index;

                    var spanTime = Scripts.Elements.Create('span', 'listCard', null,
                        null, null, ['badge', 'bg-primary', 'rounded-pill', 'spanTime']);

                    spanTime.innerText = timeString;

                    cabecalho.appendChild(titulo);
                    cabecalho.appendChild(titulo);
                    //cabecalho.appendChild(spanIndex);
                    card.append(cabecalho);
                    card.appendChild(spanTime);

                    return card;

                } catch (error) {
                    console.log(error);
                }
            }
        }

        var ImplementGrafico = async (dataOptions) => {
            try {

                var Wallet = await CarregaDados(dataOptions);

                var chartData = ChartData;

                var data = new Array;
                var dataSet = new Array;
                var label = new Array;
                var totalizador = 0;

                var ol = Scripts.Elements.Create('ol', 'listCard', null, null, 'height: 100% !important; overflow: auto !important;', ['list-group', 'list-group-numbered']);

                var configTime = null;

                for (var i = 0; i < Wallet.Cards.length; i++) {
                    ol.appendChild(ImplementList.Cards(i + 1, Wallet.Cards[i]?.CodCard, Wallet.Cards[i]?.Amount,
                        Wallet.Cards[i]?.TimeString, Wallet.Cards[i]?.title ?? ' - ', Wallet.Cards[i]?.Description));

                    totalizador += parseFloat(Wallet.Cards[i].Amount.replaceAll("R$", "").replaceAll(",", "."));
                }

                for (var i = 0; i < MonthColor.length; i++) {                    
                    var result = Wallet.Cards.filter(x => x.TimeString.indexOf(MonthColor[i].month) > -1);                                 

                    if (Array.isArray(result)) {
                        var total = 0;
                        for (var o = 0; o < result.length; o++) {
                            total += parseFloat(Wallet.Cards[o].Amount.replaceAll("R$", "").replaceAll(",", "."));
                        }

                        data.push(total);

                    } else if (result != null) {
                        data.push(parseFloat(result.Amount.replaceAll("R$", "").replaceAll(",", ".")));
                    }

                    label.push(MonthColor[i].month);
                }

                dataSet.push({
                        label: ["Gastos"],
                        data: data,
                        backgroundColor: '#7542ff',
                        borderWidth: 2,
                        borderColor: '#7542ff'
                    });

                document.getElementById("listCards").appendChild(ol);

                var divTotalizador = Scripts.Elements.Create('div', null, null,
                    null, "display: flex; align-items: center; justify-content: center;", ['totalizador', 'cards']);

                var spanTotalizador = Scripts.Elements.Create('span', null, null,
                    null);

                spanTotalizador.innerText = `Total: ${totalizador.toLocaleBR(totalizador)}`;

                divTotalizador.appendChild(spanTotalizador);
                divTotalizador.append(Scripts.Elements.Create('i', null, null,
                    null, null, ["fas", "fa-coins"]));
                document.getElementById("listCards").appendChild(divTotalizador);

                chartData.labels = label;
                chartData.datasets = dataSet;
                
                Scripts.Grafico.NewChart(Scripts.Grafico.ConfigChart('line', chartData),
                    "graficoLine");                             

            } catch (error) {
                console.log(error);
            }
        }        

        var DeleteAll = function async (){

            if(confirm('Deseja apagar todos os registros desse Banco?')){
                return new Promise((resolve) => {
                    var options = AjaxOptions;
                    options.url = `${urlAPI}Wallet/DeleteAllCards`;
                    options.method = 'POST';

                    options.onload = (xhr, obj) => {
                        
                        if (xhr.currentTarget.response != null && xhr.currentTarget.response != undefined) {
                            if (xhr.currentTarget.response == false) {
                                alert(`Ocorreu um erro durante o processo.`);
                                resolve(false);
                            }                        
                            AtualizaList();
                            resolve(true);
                        } else {
                            alert("Nenhum dado foi excluído.");
                        }
                    }

                    options.data = recuperaUserCodCookie();

                    Scripts.API.POST(options);
                });
            }
            
        }

        var ImplementMonthsOptions = () =>{
            try{               

                for(var i = 0; i <= MonthColor.length; i++){
                    var checkbox = Scripts.Elements.Create('input', `option${MonthColor[i].month}`, 'month',
                        'btn-check', null, null, (event) => {AtualizaDados(event, event.target);}, 'checkbox');

                    var label = Scripts.Elements.Create('label', null, null,
                        'btn-check', null, ['btn', 'btn-outline-primary']);
                    
                    checkbox.value = MonthColor[i].month;
                    
                    label.innerText = MonthColor[i].month;
                    label.htmlFor = `option${MonthColor[i].month}`;
                    
                    document.getElementById('groupMonth').appendChild(checkbox);
                    document.getElementById('groupMonth').appendChild(label);
                }

            }catch(Error){

            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try{
                
                ImplementGrafico();
                ImplementMonthsOptions();

                document.getElementById('userName').textContent = `Bem vindo ao seu painel de controle de bancos, ${recuperaUserNameCookie()}`
            }catch(Error){
                log(Error);
            }            
        });
    </script>

    <link rel="stylesheet" href="/Library.Front/Library/css/style.padrao.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        #graficoLine{
            width: 100% !important;            
        }

        .buttonPanel {
            background-color: white !important;
            border: 0;
            color: var(--colorPrymary5) !important;
            font-weight: 600 !important;
            width: 100% !important;
            transition: background-color 0.5s;
        }

            .buttonPanel:hover {
                background-color: var(--colorPrymary5) !important;
                color: white !important;
                font-weight: 600 !important;
                transition: background-color 0.5s;
            }

            .buttonPanel:disabled {
                background-color: var(--colorPrymary5) !important;
                opacity: 50% !important;
                color: white !important;
            }

        .panel {
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-content: center;
            text-align: center;
            padding-top: 12% !important;
        }

        footer {
            position: fixed;
            background-color: var(--colorPrymary5);
            height: 6%;
            width: 100%;
            display: flex;
            flex-direction: row-reverse;
            color: white;
            justify-content: center;
            align-items: center;
            font-size: 2vh;
            bottom: 0px;
        }

        .totalizador {
            width: 100%;
            height: 60px;
            background-color: var(--colorPrymary5);
            border-radius: 10px;
            margin-top: 21px;
        }

        .iconFooter {
            transform: rotate( 261deg );
            padding-top: 1%;
            padding-right: 0.4%;
        }        

        #userName {
            top: 2%;
            left: 5%;
            position: absolute;
            color: var(--colorPrymary6);
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <a style=" background-color: transparent; position: absolute; top: 11%; left: 4%;" href="/Admin/Projects/Intru/Intru.html"><i class="fas fa-rocket backMenu"></i></a>
    <a href="https://app.nubank.com.br/#/login" target="_blank"><img class="logo" src="/img/nubank-logo.png" alt="Logo-Nubank" /></a>    
    <label id="userName"></label>
    <label id="logout" onclick="logOut();">Logout</label>
    <div class="panel">
        <div class="container">
            <h1 style="color: var(--colorPrymary5);">Estatisticas</h1>
           <!-- <div style="margin: 10px;"class="btn-group" role="group" aria-label="Basic radio toggle button group">
                <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="btnradio1">Sintetico</label>
              
                <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off">
                <label class="btn btn-outline-primary" for="btnradio3">Analitico</label>
            </div>
           -->
            <div name="frameCarrousel" class="carousel-item active">
                <canvas id="graficoLine"></canvas>
            </div>
        </div>

        <div id="listCards" style="height: 59% !important;" class="container">
            <div style="width: 100%; flex-direction: column;" class="btn-group" role="group" aria-label="Basic example">                                     
                <button id="monthOptions" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                    All
                </button>                
                <div class="collapse" id="collapseExample">
                    <div class="card card-body">
                        <div class="btn-group" role="group" id="groupMonth">
                            <input value="All" checked type="checkbox" class="btn-check" name="month" id="All" autocomplete="off">
                            <label class="btn btn-outline-primary" for="All">All</label>                          
                        </div>
                    </div>
                </div>
            </div>
            <div style="width: 100%;" class="btn-group" role="group" aria-label="Basic example">     
                <button type="button" class="btn btn-primary buttonPanel"><i class="far fa-check-square"></i> Todos</button>
                <button type="button" class="btn btn-primary buttonPanel" disabled><i class="fas fa-eraser"></i> Apagar</button>
                <button type="button" class="btn btn-primary buttonPanel" onclick="DeleteAll();"><i class="far fa-trash-alt"></i> Apagar Todas</button>
                <button id="refresh"type="button" class="btn btn-primary buttonPanel" onclick="AtualizaList();" ><i class="fas fa-sync-alt"></i> Atualizar <i id="icoRefresh" class="far fa-dot-circle"></i></button>
            </div>            
        </div>
    </div>
    <footer><i class="fas fa-meteor iconFooter"></i> Intru 1.1 - INTRU INC.</footer>
</body>
</html>